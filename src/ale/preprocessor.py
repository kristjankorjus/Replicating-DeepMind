"""

Preprocessor takes images from ALE and turns them into cropped, downscaled arrays of grayscale values.

"""

from PIL import Image
import numpy as np


class Preprocessor:
    ORIGINAL_HEIGHT = 210
    ORIGINAL_WIDTH = 160

    grayscale_array = None

    def __init__(self):
        """
        Initialise preprocessor
        """
        self.grayscale_array = self.get_grayscale_array()

    def process(self, image_string):
        """
        Returns the cropped, downscaled, grayscale array representation of the image.
        @param image_string: a string that ALE outputs, corresponding to a 160x210 color image
        """
        height = self.ORIGINAL_HEIGHT
        width = self.ORIGINAL_WIDTH
        arr = self.grayscale_array

        img = Image.new('RGB', (width, height), "black")  # create a new black image
        pixels = img.load()                               # get the pixel map

        # Fill the PIL image object with the correct pixel values
        for i in range(len(image_string)/2):
            num_rows = i % width
            num_cols = i / width

            hex1 = int(image_string[i*2], 16)

            # Division by 2 because: http://en.wikipedia.org/wiki/List_of_video_game_console_palettes
            hex2 = int(image_string[i*2+1], 16)/2
            gray_val = int(arr[hex2, hex1])
            pixels[num_rows, num_cols] = (gray_val, gray_val, gray_val)

        # Crop and downscale image
        roi = (0, 33, 160, 193)  # region of interest is lines 33 to 193
        img = img.crop(roi)
        new_size = 84, 84
        img.thumbnail(new_size)

        # Get pixel data again
        raw_pixels = np.asarray(img, dtype=np.uint8)

        # Return only R value from RGB representation because R=G=B here.
        return raw_pixels[:, :, 0]

    def get_grayscale_array(self):
        """
        Returns the (numpy) array that is used for mapping NTSC colors to grayscale values
        """
        
        my_array = np.array(
            [[0.000000000000000000e+00, 6.256000000000000227e+01, 5.192000000000000171e+01, 4.475999999999999801e+01, 2.855999999999999872e+01, 3.164000000000000057e+01, 2.351999999999999957e+01, 1.344000000000000128e+01, 9.520000000000001350e+00, 2.571999999999999886e+01, 3.767999999999999972e+01, 4.567999999999999261e+01, 4.259999999999999432e+01, 4.396000000000000085e+01, 4.332000000000000028e+01, 4.267999999999999972e+01], 
            [6.335999999999999943e+01, 9.312000000000000455e+01, 7.740000000000000568e+01, 7.052000000000001023e+01, 5.771999999999999886e+01, 6.023999999999999488e+01, 5.295999999999999375e+01, 4.343999999999999773e+01, 3.951999999999999602e+01, 5.571999999999999886e+01, 6.823999999999999488e+01, 7.623999999999999488e+01, 7.427999999999998693e+01, 7.819999999999998863e+01, 7.471999999999998465e+01, 7.380000000000001137e+01], 
            [1.069199999999999875e+02, 1.239599999999999937e+02, 1.000399999999999920e+02, 9.627999999999998693e+01, 8.376000000000000512e+01, 8.571999999999998465e+01, 7.928000000000000114e+01, 7.059999999999999432e+01, 6.951999999999999602e+01, 8.316000000000001080e+01, 9.568000000000000682e+01, 1.067999999999999972e+02, 1.059599999999999937e+02, 1.087599999999999909e+02, 1.050000000000000000e+02, 1.049200000000000017e+02], 
            [1.425600000000000023e+02, 1.508399999999999750e+02, 1.255199999999999960e+02, 1.192000000000000028e+02, 1.089599999999999937e+02, 1.103599999999999994e+02, 1.047599999999999909e+02, 9.775999999999999091e+01, 9.555999999999998806e+01, 1.094799999999999898e+02, 1.225600000000000023e+02, 1.365199999999999818e+02, 1.365199999999999818e+02, 1.361999999999999886e+02, 1.324399999999999977e+02, 1.320799999999999841e+02], 
            [1.742399999999999807e+02, 1.737599999999999625e+02, 1.441999999999999886e+02, 1.410000000000000000e+02, 1.310399999999999920e+02, 1.321599999999999966e+02, 1.274000000000000057e+02, 1.201200000000000045e+02, 1.187600000000000051e+02, 1.326800000000000068e+02, 1.460399999999999920e+02, 1.600000000000000000e+02, 1.602800000000000011e+02, 1.627999999999999829e+02, 1.590399999999999920e+02, 1.555599999999999739e+02], 
            [1.980000000000000000e+02,  1.969600000000000080e+02, 1.628799999999999955e+02, 1.599600000000000080e+02, 1.531200000000000045e+02, 1.508400000000000034e+02, 1.469199999999999875e+02, 1.433199999999999932e+02, 1.411200000000000045e+02, 1.521999999999999886e+02, 1.686800000000000068e+02, 1.857599999999999909e+02, 1.868800000000000239e+02, 1.862800000000000011e+02, 1.825200000000000102e+02, 1.790399999999999920e+02],
            [2.177999999999999829e+02, 2.198799999999999955e+02, 1.812800000000000011e+02, 1.778000000000000114e+02, 1.743599999999999852e+02, 1.715199999999999818e+02, 1.684399999999999977e+02, 1.654000000000000057e+02, 1.632000000000000171e+02, 1.745600000000000023e+02, 1.913200000000000216e+02, 2.055600000000000023e+02, 2.077999999999999829e+02, 2.097600000000000193e+02, 2.028799999999999955e+02, 2.022400000000000091e+02], 
            [2.336400000000000148e+02, 2.391199999999999761e+02, 1.999600000000000080e+02, 1.967599999999999909e+02, 1.933199999999999932e+02, 1.901999999999999886e+02, 1.871200000000000045e+02, 1.849200000000000159e+02, 1.827199999999999704e+02, 1.940799999999999841e+02, 2.111200000000000045e+02, 2.281999999999999886e+02, 2.304399999999999977e+02, 2.323999999999999773e+02, 2.255199999999999818e+02, 2.217599999999999909e+02]]
        )

        return my_array
